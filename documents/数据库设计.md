#### user

复用博客系统的登录接口，单点登录（多用户/多端同步历史需要）

> 博客系统的具体表结构（博客系统用的mysql）如下，本系统不再需要user表
>
> ==注意保证两个系统jwt库版本一致==

| 字段名          | 数据类型      | 说明         | 备注                                    |      |
| --------------- | ------------- | ------------ | --------------------------------------- | ---- |
| id              | bigint        | 主键         | 自增                                    |      |
| username        | varchar(32)   | 用户名       | 唯一                                    |      |
| password        | varchar(255)  | 密码         | 不要存明文密码! 存哈希值                |      |
| phone           | varchar(11)   | 手机号       |                                         |      |
| email           | varchar(100)  |              | 邮箱，可用于订阅文章，必须唯一          |      |
| avatar          | varchar(1000) | 头像图片路径 |                                         | 可选 |
| gender          | tinyint       | 性别         | 约定：0保密/未知 1男 2女                | 可选 |
| status          | tinyint       | 账号状态     | 0正常  1锁定                            | 必须 |
| last_login_time | datetime      | 最后登录时间 | 记录最后登录时间，用于安全审计          |      |
| role            | tinyint       | 角色         | 约定：0管理员  1作者 2用户（默认设为2） | 必须 |
| created_at      | datetime      | 创建时间     |                                         |      |
| updated_at      | datetime      | 最后修改时间 |                                         |      |



---

#### group



| 字段名     | 数据类型     | 说明     | 备注                                    |
| ---------- | ------------ | -------- | --------------------------------------- |
| id         | bigserial    | 分组ID   | [非空]**主键**；                        |
| user_id    | bigserial    | 所属用户 | [非空]外键 → `user.id`；不可为空        |
| name       | varchar(50)  | 分组标题 | [非空]必填；如 “对话 123456”、“xxx.pdf” |
| sort       | int4         | 用于排序 | [非空]默认为0，降序排序                 |
| status     | boolean      | 状态     | [非空]true正常 false已删除（软删）      |
| created_at | timestamp(0) | 创建时间 | [非空]默认 now()（用于历史列表排序）    |





---

#### chat_session

会话表：统一承载前端的 **AI聊天(chat)** / **ChatPDF(pdf)** / **哄哄模拟器(game)** / **智能客服(service)** 四类会话。

> 和 `user` 是多对一关系（不允许 `user_id` 为空，登录之后才能使用）。

| 字段名          | 数据类型      | 说明             | 备注 |
| --------------- | ------------- | ---------------- | ---- |
| id              | bigserial | 会话ID           | [非空]**主键**； |
| user_id         | bigserial  | 所属用户         | [非空]外键 → `user.id`；不可为空 |
| group_id | bigserial | 分组id | 外键 → `group.id`；可为空 |
| title           | varchar(255)  | 会话标题         | [非空] 如 “对话 123456”、“xxx.pdf” |
| status          | boolean       | 状态             | [非空]true正常 false已删除（软删） |
| last_active_at | timestamp(0)  | 最后活跃时间     | [非空]用于历史列表排序 |
| created_at | timestamp(0)  | 创建时间         | [非空]默认 now() |
| updated_at | timestamp(0)  | 更新时间         | [非空]默认 now() |

> 索引建议：`(user_id, type, last_message_at desc)`、`(type, last_message_at desc)`。

---

#### chat_message(chat_history)

消息表：存储每个会话中的消息（user/assistant/system），支持流式输出场景下的“最终落库”。

> 和 `chat_session` 是多对一关系。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | [非空]自增 |
| session_id   | bigserial | 会话ID           | [非空]外键 → `chat_session.id` |
| role         | varchar(16)   | 角色             | [非空]默认U，约定：`U(user) / A(ai/assistant) / system` |
| content      | text          | 消息内容         | [非空]纯文本或 Markdown（客服/ChatPDF 的 assistant 往往是 Markdown） |
| status | boolean | 状态 | [非空]true 正常；false 已删除 |
| metadata_json| jsonb         | 扩展信息         | 可存：模型名、token统计、thinking片段汇总、解析到的“原谅值”等 |
| created_at  | timestamp(0)  | 创建时间         | [非空]默认 now() |

> 索引建议：`(session_id, id)`（按消息顺序分页）、`(session_id, last_active_at)`。
>
> 可加`user_id, status, last_active_at`联合索引

---

#### attachment

> #### (multimodal_data)

多模态数据支持表：对应前端 AIChat 上传的 image/audio/video 文件（以及未来可能的任意文件）。

> 可以绑定到“某条消息”

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | [非空]自增不可为空 |
| message_id   | bigserial | 消息ID           | [非空]外键 → `chat_message.id`； |
| file_name    | varchar(512)  | 原始文件名       | [非空] |
| mime_type    | varchar(128)  | MIME 类型        | [非空]如 `image/png`、`audio/mpeg`、`video/mp4` |
| file_size | bigserial | 文件大小 | 最大约9EB，覆盖所有可能文件大小 |
| ~~storage_type~~ | varchar(16)   | 存储类型         | [非空]约定：` oss / others `（按部署方式选择）<br />本项目不需要该字段 |
| storage_path | varchar(2048) | 存储路径/URL     | [非空]本地路径或对象存储URL/Key |
| sha256       | varchar(64)   | 内容哈希         | [非空]用于去重/完整性校验 |
| created_at  | timestamp(0)  | 创建时间         | [非空]默认 now() |

设置上传大小限制，防止用户上传过大的文件导致服务器资源耗尽

> 索引建议：`(session_id)`、`(message_id)`、`(sha256)`。
>
> 
>
> ==sha256的作用==
>
> - 上传相同文件时，可以通过sha256检查是否已存在，避免重复存储，节省存储空间
> - 可以用于**构建唯一文件标识**，如`/files/{sha256}.{ext}`，避免文件名冲突
>
> ==mime_type字段==
>
> * 安全防护
>
>   - "在文件上传场景中，服务器可以通过校验MIME类型限制用户上传的文件类型，防止恶意文件（如可执行文件）被上传。"
>   - 示例（Python）：`allowed_mime = {'image/jpeg', 'image/png'} if uploaded_file.mimetype not in allowed_mime: raise ValueError("仅支持JPEG或PNG图片！")`
>
> * 正确文件处理
>
>   - 知识库[6]提到："浏览器根据Content-Type响应头中的MIME类型决定如何处理文件"
>   - 例如：`image/jpeg`会显示为图片，`application/pdf`会触发PDF下载
>
> * 文件类型验证
>
>   - 上传文件时，系统可以验证文件的实际类型是否与上传的扩展名一致
>   - 防止用户上传"恶意文件"（如将.exe文件命名为.jpg）
>
> * 用户体验
>
>   - 系统可以正确识别文件类型，提供相应的预览功能
>   - 例如：图片文件可以显示缩略图，PDF文件可以提供预览功能
>
>   **示例**：如果用户上传了一个文件，名为`document.jpg`，但实际内容是PDF，系统可以通过`mime_type`字段检测到这不是图片，而是PDF，从而拒绝上传或提示用户。







---

#### 后期

####  **用户行为分析表（重要补充）**

- 用于分析用户使用习惯，优化AI服务
- "用户画像"需要基础数据

```
| 字段名 | 数据类型 | 说明 | 备注 |
| --- | --- | --- | --- |
| id | BIGINT AUTO_INCREMENT | 行为ID | 主键 |
| user_id | BIGINT | 用户ID | 外键 → user.id |
| action_type | VARCHAR(32) | 行为类型 | 如"chat_start", "pdf_upload" |
| action_data | JSON | 行为数据 | |
| create_time | TIMESTAMP | 行为时间 | 默认 NOW() |
```



> #### **模型使用统计表（重要补充）**
>
> 
>
> - 用于监控AI模型使用情况，优化资源分配
> - 企业级应用需要监控模型负载
>
> **建议表结构**：
>
> ```
> | 字段名 | 数据类型 | 说明 | 备注 |
> | --- | --- | --- | --- |
> | id | BIGINT AUTO_INCREMENT | 统计ID | 主键 |
> | model_name | VARCHAR(64) | 模型名称 | 如"qwen-max" |
> | session_count | INT | 会话数量 | |
> | token_count | BIGINT | Token使用量 | |
> | cost | DECIMAL(10,2) | 费用 | |
> | create_date | DATE | 统计日期 | |
> ```



---

#### 使用 PostgreSQL（推荐）

本项目推荐 PostgreSQL，原因（结合本项目的实际字段）：

- **JSONB**：`chat_message.metadata_json`、`pdf_session_link.metadata_json`、`service_booking.payload_json` 需要灵活承载扩展信息。
- **更友好的全文/索引扩展**：未来 ChatPDF 做“个人知识库检索”可以直接接 `pgvector` / 全文检索。



