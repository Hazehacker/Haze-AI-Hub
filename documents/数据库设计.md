#### user

复用博客系统的登录接口，单点登录（多用户/多端同步历史需要）

> 博客系统的具体表结构（博客系统用的mysql）如下，本系统不再需要user表
>
> ==注意保证两个系统jwt库版本一致==

| 字段名          | 数据类型      | 说明         | 备注                                    |      |
| --------------- | ------------- | ------------ | --------------------------------------- | ---- |
| id              | bigint        | 主键         | 自增                                    |      |
| username        | varchar(32)   | 用户名       | 唯一                                    |      |
| password        | varchar(255)  | 密码         | 不要存明文密码! 存哈希值                |      |
| phone           | varchar(11)   | 手机号       |                                         |      |
| email           | varchar(100)  |              | 邮箱，可用于订阅文章，必须唯一          |      |
| avatar          | varchar(1000) | 头像图片路径 |                                         | 可选 |
| gender          | tinyint       | 性别         | 约定：0保密/未知 1男 2女                | 可选 |
| status          | tinyint       | 账号状态     | 0正常  1锁定                            | 必须 |
| last_login_time | datetime      | 最后登录时间 | 记录最后登录时间，用于安全审计          |      |
| role            | tinyint       | 角色         | 约定：0管理员  1作者 2用户（默认设为2） | 必须 |
| created_at      | datetime      | 创建时间     |                                         |      |
| updated_at      | datetime      | 最后修改时间 |                                         |      |



---





#### chat_session

会话表：统一承载前端的 **AI聊天(chat)** / **ChatPDF(pdf)** / **哄哄模拟器(game)** / **智能客服(service)** 四类会话。

> 和 `user` 是多对一关系（不允许 `user_id` 为空，登录之后才能使用）。

| 字段名          | 数据类型      | 说明             | 备注 |
| --------------- | ------------- | ---------------- | ---- |
| id              | bigserial | 会话ID           | **主键**；直接复用前端 `chatId`（当前为时间戳字符串或 `pdf_...`） |
| user_id         | bigserial  | 所属用户         | 外键 → `user.id`；不可为空 |
| type            | varchar(16)   | 会话类型         | 约定：`chat / pdf / game / service` |
| title           | varchar(255)  | 会话标题         | 可选；如 “对话 123456”、“xxx.pdf” |
| status          | boolean       | 状态             | true正常 false已删除（软删） |
| last_active_at | timestamp(0)  | 最后活跃时间     | 用于历史列表排序 |
| created_at | timestamp(0)  | 创建时间         | 默认 now() |
| updated_at | timestamp(0)  | 更新时间         | 默认 now() |

> 索引建议：`(user_id, type, last_message_at desc)`、`(type, last_message_at desc)`。

---

#### chat_message

消息表：存储每个会话中的消息（user/assistant/system），支持流式输出场景下的“最终落库”。

> 和 `chat_session` 是多对一关系。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | 自增 |
| session_id   | bigserial | 会话ID           | 外键 → `chat_session.id` |
| role         | varchar(16)   | 角色             | 约定：`user / assistant / system` |
| content      | text          | 消息内容         | 纯文本或 Markdown（客服/ChatPDF 的 assistant 往往是 Markdown） |
| metadata_json| jsonb         | 扩展信息         | 可存：模型名、token统计、thinking片段汇总、解析到的“原谅值”等 |
| created_at  | timestamp(0)  | 创建时间         | 默认 now() |

> 索引建议：`(session_id, id)`（按消息顺序分页）、`(session_id, created_at)`。

---

#### attachment

多模态附件表：对应前端 AIChat 上传的 image/audio/video 文件（以及未来可能的任意文件）。

> 既可以绑定到“某条消息”，也可以仅绑定到“某个会话”（例如先上传文件再提问）。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | 自增 |
| session_id   | varchar(64)   | 会话ID           | 外键 → `ai_chat_session.id` |
| message_id   | bigint        | 消息ID           | 外键 → `ai_chat_message.id`；可为空 |
| file_name    | varchar(512)  | 原始文件名       |      |
| mime_type    | varchar(128)  | MIME 类型        | 如 `image/png`、`audio/mpeg`、`video/mp4` |
| file_size    | bigint        | 文件大小         | 单位 bytes |
| storage_type | varchar(16)   | 存储类型         | 约定：`local / s3 / oss`（按你部署方式选择） |
| storage_path | varchar(2048) | 存储路径/URL     | 本地路径或对象存储URL/Key |
| sha256       | varchar(64)   | 内容哈希         | 用于去重/完整性校验（可选） |
| created_at  | timestamp(0)  | 创建时间         | 默认 now() |

> 索引建议：`(session_id)`、`(message_id)`、`(sha256)`（可选）。

---

#### pdf_document

PDF 文档表：对应 ChatPDF 上传的 PDF 文件元信息（文件本体建议存对象存储，本地开发可先落磁盘）。

> 和 `ai_chat_session(type='pdf')` 通常是一对一关系，但设计成一对多也能支持“同一 PDF 多个会话”。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | 自增 |
| owner_user_id| bigint        | 所属用户         | 外键 → `user.id`；可为空（匿名） |
| file_name    | varchar(512)  | 文件名           |      |
| file_size    | bigint        | 文件大小         | bytes |
| storage_type | varchar(16)   | 存储类型         | `local / s3 / oss` |
| storage_path | varchar(2048) | 存储路径/URL     | 后端 `/ai/pdf/file/{chatId}` 可通过它回源 |
| sha256       | varchar(64)   | 内容哈希         | 用于去重/复用 |
| status       | boolean       | 状态             | true可用 false已删除 |
| created_at  | timestamp(0)  | 创建时间         | 默认 now() |
| updated_at  | timestamp(0)  | 更新时间         | 默认 now() |

---

#### pdf_session_link

PDF 会话关联表：把 `ai_chat_session(type='pdf')` 和 `pdf_document` 关联起来，并记录解析/索引状态（未来做“个人知识库向量检索”也从这里扩展）。

| 字段名          | 数据类型     | 说明             | 备注 |
| -------------- | ------------ | ---------------- | ---- |
| id              | bigserial    | 主键             | 自增 |
| session_id      | varchar(64)  | 会话ID           | 外键 → `ai_chat_session.id`；唯一（若一会话只绑定一个PDF） |
| pdf_id          | bigint       | PDF ID           | 外键 → `pdf_document.id` |
| parse_status    | varchar(16)  | 解析状态         | 约定：`pending / parsing / done / failed` |
| parse_error     | text         | 失败原因         | 可为空 |
| extracted_text  | text         | 提取的纯文本     | 可选；大文件不建议全存，建议存分段表或对象存储 |
| metadata_json   | jsonb        | 解析元信息       | 页数、目录、分段信息、向量索引信息等 |
| created_at     | timestamp(0) | 创建时间         | 默认 now() |
| updated_at     | timestamp(0) | 更新时间         | 默认 now() |

> 索引建议：`(pdf_id)`、`unique(session_id)`（按你的业务规则选择）。

---

#### service_booking

客服预约表：前端在客服对话里检测到“预约编号”后会弹窗展示，后端后续落地时建议将预约信息结构化入库。

> 和 `ai_chat_session(type='service')` 是多对一关系；也可以绑定到触发预约的消息 `message_id`。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| id           | bigserial     | 主键             | 自增 |
| booking_no   | varchar(64)   | 预约编号         | 唯一 |
| session_id   | varchar(64)   | 会话ID           | 外键 → `ai_chat_session.id` |
| message_id   | bigint        | 触发预约的消息ID | 外键 → `ai_chat_message.id`；可为空 |
| user_id      | bigint        | 用户ID           | 外键 → `user.id`；可为空 |
| payload_json | jsonb         | 预约详情         | 课程/时间/手机号/备注等（以最终产品形态为准） |
| status       | varchar(16)   | 状态             | 约定：`created / confirmed / cancelled / finished` |
| created_at  | timestamp(0)  | 创建时间         | 默认 now() |
| updated_at  | timestamp(0)  | 更新时间         | 默认 now() |

---

#### （可选）game_session_state

哄哄模拟器扩展表：记录每局游戏的状态（轮次、原谅值等）。如果你觉得这些状态不需要长期保存，也可以全部塞到 `ai_chat_session.metadata_json` 里省一张表。

| 字段名        | 数据类型      | 说明             | 备注 |
| ------------ | ------------- | ---------------- | ---- |
| session_id   | varchar(64)   | 会话ID           | **主键**；外键 → `ai_chat_session.id` |
| max_rounds   | int           | 最大轮次         | 默认 10 |
| current_round| int           | 当前轮次         | 默认 0 |
| forgiveness  | int           | 原谅值(0-100)    | 默认 0 |
| is_over      | boolean       | 是否结束         | 默认 false |
| result_text  | text          | 结局文案         | 可为空 |
| created_at  | timestamp(0)  | 创建时间         | 默认 now() |
| updated_at  | timestamp(0)  | 更新时间         | 默认 now() |

---

#### 使用 PostgreSQL（推荐）

本项目推荐 PostgreSQL，原因（结合本项目的实际字段）：

- **JSONB**：`ai_chat_message.metadata_json`、`pdf_session_link.metadata_json`、`service_booking.payload_json` 需要灵活承载扩展信息。
- **更友好的全文/索引扩展**：未来 ChatPDF 做“个人知识库检索”可以直接接 `pgvector` / 全文检索。

